{% extends 'base.html' %}

{% block css %}
<style>
    #patient_search {
        width: 100%;
    }
    #patient_select {
        width: 100%;
        box-sizing: border-box;
        display: none; /* Initially hidden */
        position: absolute;
        z-index: 1000; /* Ensure it appears above other elements */
        background-color: white;
        border: 1px solid #ccc;
        max-height: 150px;
        overflow-y: auto;
    }
    #patient_select option {
        padding: 8px;
        cursor: pointer;
    }
    #patient_select option:hover, #patient_select option.selected {
        background-color: #f0f0f0;
    }
</style>
{% endblock css %}

{% block content %}
<div class="wrapper">
    <!-- Right side column. Contains the navbar and content of the page -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>Add New Appointment</h1>
            <ol class="breadcrumb">
                <li><a href="/"><i class="fa fa-dashboard"></i> Home</a></li>
                <li><a href="/">Tables</a></li>
                <li class="active">Data tables</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header">
                            <h3 class="box-title">Fill Complete Appointment Details</h3>
                        </div><!-- /.box-header -->
                        <div class="box-body">
                            <div class="box box-primary">
                                <!-- form start -->
                                <form id="store_form" role="form">{% csrf_token %}
                                    <div class="box-body">
                                        <div class="row">
                                            <div class="col-lg-6">
                                                <div class="form-group">
                                                    <label class="form-label">Patient</label>
                                                    <input type="text" class="form-control" id="patient_search" name="search" placeholder="Search Patient">
                                                    <select id="patient_select" size="5"></select>
                                                </div>
                                            </div>
                                            <div class="col-lg-6">
                                                <div class="form-group">
                                                    <label class="form-label">Doctor</label>
                                                    <select name="doctor" id="doctor" class="form-control">
                                                        <option value="0">Select Doctor</option>
                                                        {% for i in doctor %}
                                                        <option value="{{i.id}}">{{i.user.username}}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <div id="doctor_suggestions"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- /.box-body -->
                                    <div class="box-footer">
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                    </div>
                                </form>
                            </div>
                        </div><!-- /.box-body -->
                    </div><!-- /.box -->
                </div><!-- /.col -->
            </div><!-- /.row -->
        </section><!-- /.content -->
    </div><!-- /.content-wrapper -->
</div><!-- ./wrapper -->
{% endblock content %}

{% block js %}
<script>
    $(document).ready(function(){
        let selectedOptionIndex = -1;

        $('#store_form').on('submit', function (e) {
            e.preventDefault();
            var formData = $('#store_form').serialize();
            $.ajax({
              url: '/appointment/add_appointment/',
              type: 'POST',
              data: formData,
              success: function (response) {
                if(response.status == 'success'){
                  Swal.fire({
                    title: 'Success',
                    text: response.msg,
                    icon: 'success',
                    showCancelButton: false,
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                  }).then((result) => {
                    window.location.href = '/account/doctor_registration/';
                  });
                }else{
                  Swal.fire({
                      title: 'Error',
                      text: response.msg,
                      icon: 'error',
                      confirmButtonColor: '#3085d6',
                      confirmButtonText: 'OK'
                  });
                  $('#password').val('');
                  return false;
                }
              },
            });
        });

        $('#patient_search').on('input', function() {
            var query = $(this).val();
            if (query.length > 0) {
                $.ajax({
                    url: '/appointment/search_patient/',
                    data: {
                        'term': query
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('#patient_select').empty().show();
                        $.each(data.data_list, function(index, item) {
                            $('#patient_select').append('<option value="' + item.id + '">' + item.name + ' ' + '('+ item.code+ ')' + '</option>');
                        });
                        selectedOptionIndex = -1;
                    }
                });
            } else {
                $('#patient_select').empty().hide();
            }
        });

        $('#patient_search').on('keydown', function(e) {
            var options = $('#patient_select option');
            if (options.length > 0) {
                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    selectedOptionIndex = (selectedOptionIndex + 1) % options.length;
                    options.removeClass('selected').eq(selectedOptionIndex).addClass('selected');
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    selectedOptionIndex = (selectedOptionIndex - 1 + options.length) % options.length;
                    options.removeClass('selected').eq(selectedOptionIndex).addClass('selected');
                } else if (e.key === "Enter") {
                    e.preventDefault();
                    if (selectedOptionIndex >= 0) {
                        var selectedText = options.eq(selectedOptionIndex).text();
                        $('#patient_search').val(selectedText);
                        $('#patient_select').empty().hide();
                    }
                }
            }
        });

        // Hide suggestions when clicking outside
        $(document).on('click', function(event) {
            if (!$(event.target).closest('#patient_search, #patient_select').length) {
                $('#patient_select').empty().hide();
            }
        });

        // Handle select option click
        $('#patient_select').on('change', function() {
            var selectedText = $('#patient_select option:selected').text();
            $('#patient_search').val(selectedText);
            $('#patient_select').empty().hide();
        });
    });
</script>
{% endblock js %}
